<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canva Clone - 에디터 (Phase 3)</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script> -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow: hidden;
        }

        .canva-header {
            background: white;
            border-bottom: 1px solid #e5e5e5;
            height: 56px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            justify-content: space-between;
        }

        .canva-logo {
            font-size: 24px;
            font-weight: bold;
            color: #00c4cc;
            cursor: pointer;
        }

        .sidebar {
            background: white;
            border-right: 1px solid #e5e5e5;
            width: 280px;
            height: calc(100vh - 56px);
            overflow-y: auto;
        }

        .sidebar-tab {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .sidebar-tab:hover {
            background: #f7f7f7;
        }

        .sidebar-tab.active {
            background: #f0f0f0;
            border-left: 3px solid #00c4cc;
        }

        .canvas-area {
            background: #f0f0f0;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: auto;
        }

        .canvas {
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
            cursor: default;
        }

        .canvas-element {
            position: absolute;
            cursor: move;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .canvas-element:hover {
            border-color: #00c4cc;
        }

        .canvas-element.selected {
            border-color: #00c4cc;
        }

        .canvas-element.locked {
            border-color: #ff9800;
            cursor: not-allowed;
        }

        .canvas-element.selected::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: white;
            border: 2px solid #00c4cc;
            bottom: -5px;
            right: -5px;
            cursor: nwse-resize;
        }

        .toolbar {
            background: white;
            border-bottom: 1px solid #e5e5e5;
            padding: 8px 16px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .toolbar-btn {
            padding: 8px 16px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .toolbar-btn:hover {
            background: #f7f7f7;
            border-color: #00c4cc;
        }

        .toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .primary-btn {
            background: #00c4cc;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .primary-btn:hover {
            background: #00b3bb;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 16px;
        }

        .template-card {
            aspect-ratio: 3/4;
            background: #f0f0f0;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
        }

        .template-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .element-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 16px;
        }

        .element-item {
            aspect-ratio: 1;
            background: #f7f7f7;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .element-item:hover {
            background: #e5e5e5;
            border-color: #00c4cc;
        }

        .search-box {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
            margin: 16px;
            width: calc(100% - 32px);
        }

        .search-box:focus {
            outline: none;
            border-color: #00c4cc;
        }

        .footer {
            background: white;
            border-top: 1px solid #e5e5e5;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
        }

        .zoom-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .property-panel {
            background: white;
            border-left: 1px solid #e5e5e5;
            width: 320px;
            height: calc(100vh - 56px);
            overflow-y: auto;
            padding: 16px;
        }

        .property-section {
            margin-bottom: 24px;
        }

        .property-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .color-picker {
            width: 100%;
            height: 40px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            cursor: pointer;
        }

        .slider {
            width: 100%;
            margin: 8px 0;
        }

        .text-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            font-size: 14px;
        }

        .text-input:focus {
            outline: none;
            border-color: #00c4cc;
        }

        .saving-indicator {
            padding: 6px 12px;
            background: #e6f7f8;
            color: #00c4cc;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .saving-indicator.saving {
            background: #fff3cd;
            color: #856404;
        }

        .saving-indicator.saved {
            background: #d4edda;
            color: #155724;
        }

        .back-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .back-btn:hover {
            background: #e0e0e0;
        }

        /* Phase 3 추가 스타일 */
        .upload-area {
            border: 2px dashed #e5e5e5;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            margin: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: #00c4cc;
            background: #f7f7f7;
        }

        .upload-area.dragging {
            border-color: #00c4cc;
            background: #e6f7f8;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 16px;
        }

        .upload-item {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }

        .upload-item:hover {
            transform: scale(1.05);
        }

        .upload-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .comment-marker {
            position: absolute;
            width: 32px;
            height: 32px;
            background: #ff6b6b;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 100;
        }

        .comment-marker:hover {
            transform: scale(1.1);
        }

        .version-list {
            padding: 16px;
        }

        .version-item {
            padding: 12px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .version-item:hover {
            border-color: #00c4cc;
            background: #f7f7f7;
        }

        .version-number {
            font-weight: 600;
            color: #00c4cc;
            margin-bottom: 4px;
        }

        .version-info {
            font-size: 12px;
            color: #666;
        }

        .active-users {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #00c4cc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .cursor-indicator {
            position: absolute;
            width: 20px;
            height: 20px;
            pointer-events: none;
            z-index: 1000;
            transition: all 0.1s;
        }

        .cursor-label {
            position: absolute;
            top: 20px;
            left: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
        }

        .presentation-mode {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: black;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .presentation-canvas {
            max-width: 90%;
            max-height: 90%;
            background: white;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .presentation-controls {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            padding: 12px 24px;
            border-radius: 24px;
            display: flex;
            gap: 16px;
        }

        .tab-content {
            padding: 16px;
        }

        .layer-list {
            padding: 16px;
        }

        .layer-item {
            padding: 12px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .layer-item:hover {
            background: #f7f7f7;
            border-color: #00c4cc;
        }

        .layer-item.selected {
            background: #e6f7f8;
            border-color: #00c4cc;
        }

        .layer-name {
            font-weight: 500;
        }

        .layer-controls {
            display: flex;
            gap: 8px;
        }

        .layer-btn {
            padding: 4px 8px;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .layer-btn:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_URL = 'http://localhost:3001/api';
        const SOCKET_URL = null;

        // API 헬퍼
        const api = {
            async getProject(token, projectId) {
                const res = await fetch(`${API_URL}/projects/${projectId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                return await res.json();
            },

            async updateProject(token, projectId, data) {
                const res = await fetch(`${API_URL}/projects/${projectId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                return await res.json();
            },

            async uploadFile(token, file) {
                const formData = new FormData();
                formData.append('file', file);
                
                const res = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                return await res.json();
            },

            async getUploads(token) {
                const res = await fetch(`${API_URL}/uploads`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                return await res.json();
            },

            async getComments(token, projectId) {
                const res = await fetch(`${API_URL}/projects/${projectId}/comments`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                return await res.json();
            },

            async addComment(token, projectId, data) {
                const res = await fetch(`${API_URL}/projects/${projectId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                return await res.json();
            },

            async resolveComment(token, commentId) {
                const res = await fetch(`${API_URL}/comments/${commentId}/resolve`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                return await res.json();
            },

            async getVersions(token, projectId) {
                const res = await fetch(`${API_URL}/projects/${projectId}/versions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                return await res.json();
            },

            async restoreVersion(token, projectId, versionId) {
                const res = await fetch(`${API_URL}/projects/${projectId}/restore/${versionId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                return await res.json();
            }
        };

        // 로컬 스토리지 헬퍼
        const auth = {
            getToken() {
                return localStorage.getItem('token');
            },
            getUser() {
                const user = localStorage.getItem('user');
                return user ? JSON.parse(user) : null;
            }
        };

        function CanvaEditor() {
            // 기존 상태들
            const [activeTab, setActiveTab] = useState('templates');
            const [elements, setElements] = useState([]);
            const [selectedElement, setSelectedElement] = useState(null);
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
            const [zoom, setZoom] = useState(100);
            const [history, setHistory] = useState([[]]);
            const [historyIndex, setHistoryIndex] = useState(0);
            const [canvasSize, setCanvasSize] = useState({ width: 800, height: 1000 });
            const [projectId, setProjectId] = useState(null);
            const [projectTitle, setProjectTitle] = useState('새 디자인');
            const [saveStatus, setSaveStatus] = useState('saved');
            const [lastSaved, setLastSaved] = useState(new Date());
            
            // Phase 3 상태들
            const [uploads, setUploads] = useState([]);
            const [uploading, setUploading] = useState(false);
            const [comments, setComments] = useState([]);
            const [selectedElement, setSelectedElement] = useState(null);
            const [showComments, setShowComments] = useState(false);
            const [addingComment, setAddingComment] = useState(false);
            const [commentPosition, setCommentPosition] = useState(null);
            const [versions, setVersions] = useState([]);
            const [showVersions, setShowVersions] = useState(false);
            const [activeUsers, setActiveUsers] = useState([]);
            const [remoteCursors, setRemoteCursors] = useState({});
            const [showLayers, setShowLayers] = useState(false);
            const [presentationMode, setPresentationMode] = useState(false);
            
            const canvasRef = useRef(null);
            const saveTimeoutRef = useRef(null);
            const socketRef = useRef(null);
            const fileInputRef = useRef(null);
            const user = auth.getUser();

            // WebSocket 연결
            useEffect(() => {
                if (!projectId || !user) return;
                // WebSocket 임시 비활성화
                return;
                socketRef.current = io(SOCKET_URL);

                socketRef.current.on('connect', () => {
                    console.log('✅ WebSocket connected');
                    socketRef.current.emit('join-project', {
                        projectId,
                        userId: user.id,
                        userName: user.name
                    });
                });

                socketRef.current.on('active-users', (users) => {
                    setActiveUsers(users);
                });

                socketRef.current.on('user-joined', ({ userName, activeUsers }) => {
                    setActiveUsers(activeUsers);
                    console.log(`${userName} joined the project`);
                });

                socketRef.current.on('user-left', ({ activeUsers }) => {
                    setActiveUsers(activeUsers);
                });

                socketRef.current.on('cursor-update', ({ userId, userName, x, y }) => {
                    setRemoteCursors(prev => ({
                        ...prev,
                        [userId]: { userName, x, y }
                    }));
                });

                socketRef.current.on('element-locked', ({ userId, userName, elementId }) => {
                    console.log(`${userName} selected element ${elementId}`);
                });

                socketRef.current.on('canvas-changed', ({ userId, elements }) => {
                    if (userId !== user.id) {
                        setElements(elements);
                    }
                });

                socketRef.current.on('new-comment', (comment) => {
                    setComments(prev => [...prev, comment]);
                });

                return () => {
                    if (socketRef.current) {
                        socketRef.current.emit('leave-project', {
                            projectId,
                            userId: user.id
                        });
                        socketRef.current.disconnect();
                    }
                };
            }, [projectId, user]);

            // 커서 이동 전송
            const handleMouseMove = (e) => {
                if (socketRef.current && projectId && canvasRef.current) {
                    const rect = canvasRef.current.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    socketRef.current.emit('cursor-move', {
                        projectId,
                        userId: user.id,
                        userName: user.name,
                        x, y
                    });
                }
            };

            // URL에서 프로젝트 ID 가져오기
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                if (id) {
                    setProjectId(id);
                    loadProject(id);
                    loadUploads();
                    loadComments(id);
                    loadVersions(id);
                }
            }, []);

            // 프로젝트 불러오기
            const loadProject = async (id) => {
                const token = auth.getToken();
                if (!token) {
                    alert('로그인이 필요합니다.');
                    window.location.href = 'index.html';
                    return;
                }

                try {
                    const project = await api.getProject(token, id);
                    setProjectTitle(project.title);
                    setCanvasSize({ width: project.canvas_width, height: project.canvas_height });
                    setElements(project.canvas_data || []);
                    setHistory([project.canvas_data || []]);
                } catch (err) {
                    console.error('Failed to load project:', err);
                }
            };

            // 업로드 목록 불러오기
            const loadUploads = async () => {
                const token = auth.getToken();
                try {
                    const data = await api.getUploads(token);
                    setUploads(data);
                } catch (err) {
                    console.error('Failed to load uploads:', err);
                }
            };

            // 댓글 불러오기
            const loadComments = async (id) => {
                const token = auth.getToken();
                try {
                    const data = await api.getComments(token, id);
                    setComments(data);
                } catch (err) {
                    console.error('Failed to load comments:', err);
                    setComments([]);
                }
            };

            // 버전 불러오기
            const loadVersions = async (id) => {
                const token = auth.getToken();
                try {
                    const data = await api.getVersions(token, id);
                    setVersions(data);
                } catch (err) {
                    console.error('Failed to load versions:', err);
                }
            };

            // 자동 저장
            useEffect(() => {
                if (!projectId) return;

                if (saveTimeoutRef.current) {
                    clearTimeout(saveTimeoutRef.current);
                }

                setSaveStatus('unsaved');

                saveTimeoutRef.current = setTimeout(() => {
                    saveProject();
                }, 3000);

                return () => {
                    if (saveTimeoutRef.current) {
                        clearTimeout(saveTimeoutRef.current);
                    }
                };
            }, [elements, canvasSize]);

            // 프로젝트 저장
            const saveProject = async () => {
                const token = auth.getToken();
                if (!token || !projectId) return;

                setSaveStatus('saving');

                try {
                    await api.updateProject(token, projectId, {
                        title: projectTitle,
                        canvas_data: elements,
                        canvas_width: canvasSize.width,
                        canvas_height: canvasSize.height,
                        thumbnail: null
                    });

                    setSaveStatus('saved');
                    setLastSaved(new Date());
                    
                    // WebSocket으로 변경 전송
                    if (socketRef.current) {
                        socketRef.current.emit('canvas-update', {
                            projectId,
                            userId: user.id,
                            elements
                        });
                    }
                } catch (err) {
                    console.error('Failed to save project:', err);
                    setSaveStatus('unsaved');
                }
            };

            // 파일 업로드
            const handleFileUpload = async (file) => {
                const token = auth.getToken();
                setUploading(true);

                try {
                    const result = await api.uploadFile(token, file);
                    setUploads(prev => [result.file, ...prev]);
                    alert('파일이 업로드되었습니다!');
                } catch (err) {
                    console.error('Failed to upload file:', err);
                    alert('파일 업로드에 실패했습니다.');
                } finally {
                    setUploading(false);
                }
            };

            // 드래그 앤 드롭
            const handleDrop = (e) => {
                e.preventDefault();
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            };

            // 댓글 추가
            const handleAddComment = async (content) => {
                const token = auth.getToken();
                if (!commentPosition) return;

                try {
                    await api.addComment(token, projectId, {
                        content,
                        x: commentPosition.x,
                        y: commentPosition.y
                    });
                    
                    await loadComments(projectId);
                    setAddingComment(false);
                    setCommentPosition(null);
                } catch (err) {
                    console.error('Failed to add comment:', err);
                }
            };

            // 댓글 해결
            const handleResolveComment = async (commentId) => {
                const token = auth.getToken();
                try {
                    await api.resolveComment(token, commentId);
                    await loadComments(projectId);
                } catch (err) {
                    console.error('Failed to resolve comment:', err);
                }
            };

            // 버전 복원
            const handleRestoreVersion = async (versionId) => {
                const token = auth.getToken();
                if (!confirm('이 버전으로 복원하시겠습니까?')) return;

                try {
                    const result = await api.restoreVersion(token, projectId, versionId);
                    setElements(result.canvas_data);
                    alert('버전이 복원되었습니다!');
                    setShowVersions(false);
                } catch (err) {
                    console.error('Failed to restore version:', err);
                    alert('버전 복원에 실패했습니다.');
                }
            };

            // 템플릿 데이터
            const templates = [
                { id: 1, name: 'Instagram Post', size: { width: 1080, height: 1080 }, color: '#FFE5E5' },
                { id: 2, name: 'Instagram Story', size: { width: 1080, height: 1920 }, color: '#E5F3FF' },
                { id: 3, name: 'Facebook Post', size: { width: 940, height: 788 }, color: '#FFF5E5' },
                { id: 4, name: 'Twitter Post', size: { width: 1200, height: 675 }, color: '#F0E5FF' },
                { id: 5, name: 'YouTube Thumbnail', size: { width: 1280, height: 720 }, color: '#E5FFE5' },
                { id: 6, name: 'LinkedIn Post', size: { width: 1200, height: 627 }, color: '#FFE5F5' },
            ];

            // 요소 추가
            const addElement = (type, options = {}) => {
                const newElement = {
                    id: Date.now(),
                    type,
                    x: 100,
                    y: 100,
                    width: 200,
                    height: type === 'text' ? 50 : 200,
                    rotation: 0,
                    opacity: 1,
                    ...options
                };

                const newElements = [...elements, newElement];
                setElements(newElements);
                setSelectedElement(newElement.id);
                addToHistory(newElements);
            };

            // 히스토리 관리
            const addToHistory = (newElements) => {
                const newHistory = history.slice(0, historyIndex + 1);
                newHistory.push(newElements);
                setHistory(newHistory);
                setHistoryIndex(newHistory.length - 1);
            };

            // 실행 취소/다시 실행
            const undo = () => {
                if (historyIndex > 0) {
                    setHistoryIndex(historyIndex - 1);
                    setElements(history[historyIndex - 1]);
                }
            };

            const redo = () => {
                if (historyIndex < history.length - 1) {
                    setHistoryIndex(historyIndex + 1);
                    setElements(history[historyIndex + 1]);
                }
            };

            // 요소 선택
            const selectElement = (id, e) => {
                e?.stopPropagation();
                setSelectedElement(id);
                
                if (socketRef.current) {
                    socketRef.current.emit('element-selected', {
                        projectId,
                        userId: user.id,
                        userName: user.name,
                        elementId: id
                    });
                }
            };

            // 요소 삭제
            const deleteElement = (id) => {
                const newElements = elements.filter(el => el.id !== id);
                setElements(newElements);
                setSelectedElement(null);
                addToHistory(newElements);
            };

            // 드래그 시작
            const startDrag = (e, elementId) => {
                e.stopPropagation();
                const element = elements.find(el => el.id === elementId);
                if (!element) return;

                setIsDragging(true);
                setSelectedElement(elementId);
                setDragStart({
                    x: e.clientX - element.x,
                    y: e.clientY - element.y
                });
            };

            // 드래그 중
            const onDrag = (e) => {
                if (!isDragging || !selectedElement) return;

                const newElements = elements.map(el => {
                    if (el.id === selectedElement) {
                        return {
                            ...el,
                            x: e.clientX - dragStart.x,
                            y: e.clientY - dragStart.y
                        };
                    }
                    return el;
                });

                setElements(newElements);
            };

            // 드래그 종료
            const endDrag = () => {
                if (isDragging) {
                    setIsDragging(false);
                    addToHistory(elements);
                }
            };

            // 요소 속성 업데이트
            const updateElement = (id, updates) => {
                const newElements = elements.map(el =>
                    el.id === id ? { ...el, ...updates } : el
                );
                setElements(newElements);
                addToHistory(newElements);
            };

            // 템플릿 적용
            const applyTemplate = (template) => {
                setCanvasSize(template.size);
                setElements([{
                    id: Date.now(),
                    type: 'rectangle',
                    x: 0,
                    y: 0,
                    width: template.size.width,
                    height: template.size.height,
                    color: template.color,
                    rotation: 0,
                    opacity: 1
                }]);
                addToHistory([]);
            };

            // 레이어 순서 변경
            const moveLayer = (index, direction) => {
                const newElements = [...elements];
                const newIndex = index + direction;
                
                if (newIndex < 0 || newIndex >= newElements.length) return;
                
                [newElements[index], newElements[newIndex]] = [newElements[newIndex], newElements[index]];
                setElements(newElements);
                addToHistory(newElements);
            };

            // 키보드 단축키
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        saveProject();
                    }
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                        e.preventDefault();
                        undo();
                    }
                    if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                        e.preventDefault();
                        redo();
                    }
                    if (e.key === 'Delete' && selectedElement) {
                        deleteElement(selectedElement);
                    }
                    if ((e.ctrlKey || e.metaKey) && e.key === 'd' && selectedElement) {
                        e.preventDefault();
                        const element = elements.find(el => el.id === selectedElement);
                        if (element) {
                            addElement(element.type, {
                                ...element,
                                x: element.x + 20,
                                y: element.y + 20
                            });
                        }
                    }
                    if (e.key === 'Escape') {
                        setSelectedElement(null);
                        setAddingComment(false);
                        setPresentationMode(false);
                    }
                };

                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [selectedElement, elements, historyIndex]);

            // 마우스 이벤트
            useEffect(() => {
                const handleMouseMoveGlobal = (e) => onDrag(e);
                const handleMouseUp = () => endDrag();

                if (isDragging) {
                    window.addEventListener('mousemove', handleMouseMoveGlobal);
                    window.addEventListener('mouseup', handleMouseUp);
                }

                return () => {
                    window.removeEventListener('mousemove', handleMouseMoveGlobal);
                    window.removeEventListener('mouseup', handleMouseUp);
                };
            }, [isDragging, selectedElement, dragStart]);

            const selectedElementData = elements.find(el => el.id === selectedElement);

            const getSaveStatusText = () => {
                if (saveStatus === 'saving') return '저장 중...';
                if (saveStatus === 'saved') return '저장됨';
                return '저장 안됨';
            };

            // 프레젠테이션 모드 렌더링
            if (presentationMode) {
                return (
                    <div className="presentation-mode">
                        <div 
                            className="presentation-canvas"
                            style={{
                                width: `${canvasSize.width}px`,
                                height: `${canvasSize.height}px`,
                                position: 'relative'
                            }}
                        >
                            {elements.map(element => (
                                <div
                                    key={element.id}
                                    style={{
                                        position: 'absolute',
                                        left: `${element.x}px`,
                                        top: `${element.y}px`,
                                        width: `${element.width}px`,
                                        height: `${element.height}px`,
                                        transform: `rotate(${element.rotation}deg)`,
                                        opacity: element.opacity,
                                        background: element.type === 'text' ? 'transparent' : element.color,
                                        borderRadius: element.type === 'circle' ? '50%' : '0',
                                        fontSize: element.fontSize ? `${element.fontSize}px` : '16px',
                                        fontWeight: element.fontWeight || 'normal',
                                        color: element.type === 'text' ? element.color : 'transparent',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center'
                                    }}
                                >
                                    {element.type === 'text' && (element.content || '텍스트')}
                                    {element.type === 'image' && element.src && (
                                        <img 
                                            src={element.src} 
                                            alt="" 
                                            style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                                        />
                                    )}
                                </div>
                            ))}
                        </div>
                        <div className="presentation-controls">
                            <button className="toolbar-btn" onClick={() => setPresentationMode(false)}>
                                ESC: 나가기
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div style={{ height: '100vh', display: 'flex', flexDirection: 'column' }}>
                    {/* 헤더 */}
                    <div className="canva-header">
                        <div style={{ display: 'flex', alignItems: 'center', gap: '24px' }}>
                            <button className="back-btn" onClick={() => window.location.href = 'index.html'}>
                                ← 돌아가기
                            </button>
                            <div className="canva-logo">Canva Clone</div>
                            <input 
                                type="text" 
                                value={projectTitle}
                                onChange={(e) => setProjectTitle(e.target.value)}
                                onBlur={saveProject}
                                style={{ 
                                    border: 'none', 
                                    fontSize: '14px', 
                                    padding: '8px',
                                    borderRadius: '6px',
                                    background: '#f7f7f7',
                                    minWidth: '200px'
                                }}
                            />
                        </div>
                        <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
                            {/* 활성 사용자 */}
                            {activeUsers.length > 0 && (
                                <div className="active-users">
                                    {activeUsers.map((u, i) => (
                                        <div key={i} className="user-avatar" title={u.userName}>
                                            {u.userName.charAt(0)}
                                        </div>
                                    ))}
                                </div>
                            )}
                            
                            <div className={`saving-indicator ${saveStatus}`}>
                                {getSaveStatusText()}
                            </div>
                            <button className="toolbar-btn" onClick={undo} disabled={historyIndex === 0}>
                                ↶
                            </button>
                            <button className="toolbar-btn" onClick={redo} disabled={historyIndex === history.length - 1}>
                                ↷
                            </button>
                            <button className="toolbar-btn" onClick={() => setShowComments(!showComments)}>
                                💬 댓글
                            </button>
                            <button className="toolbar-btn" onClick={() => setShowVersions(!showVersions)}>
                                📜 버전
                            </button>
                            <button className="toolbar-btn" onClick={() => setShowLayers(!showLayers)}>
                                🗂️ 레이어
                            </button>
                            <button className="toolbar-btn" onClick={() => setPresentationMode(true)}>
                                ▶️ 발표
                            </button>
                            <button className="primary-btn" onClick={saveProject}>
                                💾 저장
                            </button>
                        </div>
                    </div>

                    {/* 툴바 */}
                    {selectedElementData && (
                        <div className="toolbar">
                            <button className="toolbar-btn" onClick={() => deleteElement(selectedElement)}>
                                🗑️ 삭제
                            </button>
                            <button className="toolbar-btn" onClick={() => {
                                const element = elements.find(el => el.id === selectedElement);
                                if (element) {
                                    addElement(element.type, {
                                        ...element,
                                        x: element.x + 20,
                                        y: element.y + 20
                                    });
                                }
                            }}>
                                📋 복제
                            </button>
                        </div>
                    )}

                    <div style={{ display: 'flex', flex: 1, overflow: 'hidden' }}>
                        {/* 왼쪽 사이드바 */}
                        <div className="sidebar">
                            <input 
                                type="text" 
                                className="search-box" 
                                placeholder="템플릿 및 요소 검색..."
                            />
                            
                            <div 
                                className={`sidebar-tab ${activeTab === 'templates' ? 'active' : ''}`}
                                onClick={() => setActiveTab('templates')}
                            >
                                📄 템플릿
                            </div>
                            <div 
                                className={`sidebar-tab ${activeTab === 'elements' ? 'active' : ''}`}
                                onClick={() => setActiveTab('elements')}
                            >
                                ⭐ 요소
                            </div>
                            <div 
                                className={`sidebar-tab ${activeTab === 'text' ? 'active' : ''}`}
                                onClick={() => setActiveTab('text')}
                            >
                                ✏️ 텍스트
                            </div>
                            <div 
                                className={`sidebar-tab ${activeTab === 'uploads' ? 'active' : ''}`}
                                onClick={() => setActiveTab('uploads')}
                            >
                                📤 업로드
                            </div>

                            {/* 탭 컨텐츠 */}
                            <div>
                                {activeTab === 'templates' && (
                                    <div className="template-grid">
                                        {templates.map(template => (
                                            <div 
                                                key={template.id}
                                                className="template-card"
                                                style={{ background: template.color }}
                                                onClick={() => applyTemplate(template)}
                                            >
                                                <div style={{ padding: '12px', fontSize: '12px', fontWeight: '600' }}>
                                                    {template.name}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                {activeTab === 'elements' && (
                                    <div className="element-grid">
                                        <div className="element-item" onClick={() => addElement('rectangle', { color: '#FF6B6B' })}>
                                            ⬜
                                        </div>
                                        <div className="element-item" onClick={() => addElement('circle', { color: '#4ECDC4' })}>
                                            ⭕
                                        </div>
                                        <div className="element-item" onClick={() => addElement('triangle', { color: '#FFE66D' })}>
                                            🔺
                                        </div>
                                        <div className="element-item" onClick={() => addElement('star', { color: '#FFA07A' })}>
                                            ⭐
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'text' && (
                                    <div className="tab-content">
                                        <button 
                                            className="toolbar-btn" 
                                            style={{ width: '100%', marginBottom: '12px' }}
                                            onClick={() => addElement('text', { 
                                                content: '제목 추가',
                                                fontSize: 48,
                                                fontWeight: 'bold',
                                                color: '#000000'
                                            })}
                                        >
                                            제목 추가
                                        </button>
                                        <button 
                                            className="toolbar-btn" 
                                            style={{ width: '100%', marginBottom: '12px' }}
                                            onClick={() => addElement('text', { 
                                                content: '부제목 추가',
                                                fontSize: 32,
                                                fontWeight: '600',
                                                color: '#333333'
                                            })}
                                        >
                                            부제목 추가
                                        </button>
                                        <button 
                                            className="toolbar-btn" 
                                            style={{ width: '100%' }}
                                            onClick={() => addElement('text', { 
                                                content: '본문 텍스트',
                                                fontSize: 16,
                                                fontWeight: 'normal',
                                                color: '#666666'
                                            })}
                                        >
                                            본문 텍스트
                                        </button>
                                    </div>
                                )}

                                {activeTab === 'uploads' && (
                                    <div>
                                        <input
                                            ref={fileInputRef}
                                            type="file"
                                            accept="image/*"
                                            style={{ display: 'none' }}
                                            onChange={(e) => {
                                                if (e.target.files[0]) {
                                                    handleFileUpload(e.target.files[0]);
                                                }
                                            }}
                                        />
                                        
                                        <div 
                                            className="upload-area"
                                            onClick={() => fileInputRef.current?.click()}
                                            onDrop={handleDrop}
                                            onDragOver={(e) => e.preventDefault()}
                                        >
                                            {uploading ? (
                                                <p>업로드 중...</p>
                                            ) : (
                                                <>
                                                    <div style={{ fontSize: '48px', marginBottom: '12px' }}>📤</div>
                                                    <p style={{ fontSize: '14px', color: '#666' }}>
                                                        클릭하거나 파일을 드래그하세요
                                                    </p>
                                                    <p style={{ fontSize: '12px', color: '#999', marginTop: '8px' }}>
                                                        JPG, PNG, GIF (최대 10MB)
                                                    </p>
                                                </>
                                            )}
                                        </div>

                                        <div className="upload-grid">
                                            {uploads.map(upload => (
                                                <div 
                                                    key={upload.id}
                                                    className="upload-item"
                                                    onClick={() => addElement('image', { src: upload.url })}
                                                >
                                                    <img src={upload.url} alt={upload.original_name} />
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* 캔버스 영역 */}
                        <div 
                            className="canvas-area"
                            onClick={(e) => {
                                if (addingComment) {
                                    const rect = canvasRef.current.getBoundingClientRect();
                                    setCommentPosition({
                                        x: e.clientX - rect.left,
                                        y: e.clientY - rect.top
                                    });
                                    const content = prompt('댓글을 입력하세요:');
                                    if (content) {
                                        handleAddComment(content);
                                    } else {
                                        setAddingComment(false);
                                    }
                                } else {
                                    setSelectedElement(null);
                                }
                            }}
                            onMouseMove={handleMouseMove}
                        >
                            <div 
                                ref={canvasRef}
                                className="canvas"
                                style={{
                                    width: `${canvasSize.width}px`,
                                    height: `${canvasSize.height}px`,
                                    transform: `scale(${zoom / 100})`,
                                    transformOrigin: 'center'
                                }}
                            >
                                {/* 요소들 */}
                                {elements.map(element => (
                                    <div
                                        key={element.id}
                                        className={`canvas-element ${selectedElement === element.id ? 'selected' : ''}`}
                                        style={{
                                            left: `${element.x}px`,
                                            top: `${element.y}px`,
                                            width: `${element.width}px`,
                                            height: `${element.height}px`,
                                            transform: `rotate(${element.rotation}deg)`,
                                            opacity: element.opacity,
                                            background: element.type === 'text' ? 'transparent' : element.color,
                                            borderRadius: element.type === 'circle' ? '50%' : '0',
                                            fontSize: element.fontSize ? `${element.fontSize}px` : '16px',
                                            fontWeight: element.fontWeight || 'normal',
                                            color: element.type === 'text' ? element.color : 'transparent',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            cursor: 'move'
                                        }}
                                        onMouseDown={(e) => startDrag(e, element.id)}
                                        onClick={(e) => selectElement(element.id, e)}
                                    >
                                        {element.type === 'text' && (
                                            <div contentEditable suppressContentEditableWarning>
                                                {element.content || '텍스트'}
                                            </div>
                                        )}
                                        {element.type === 'image' && element.src && (
                                            <img 
                                                src={element.src} 
                                                alt="" 
                                                style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                                            />
                                        )}
                                    </div>
                                ))}

                                {/* 댓글 마커 */}
                                {showComments && comments.map(comment => (
                                    !comment.resolved && (
                                        <div
                                            key={comment.id}
                                            className="comment-marker"
                                            style={{
                                                left: `${comment.x}px`,
                                                top: `${comment.y}px`
                                            }}
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                if (confirm(`${comment.user_name}: ${comment.content}\n\n해결하시겠습니까?`)) {
                                                    handleResolveComment(comment.id);
                                                }
                                            }}
                                        >
                                            💬
                                        </div>
                                    )
                                ))}

                                {/* 원격 커서 */}
                                {Object.entries(remoteCursors).map(([userId, cursor]) => (
                                    <div
                                        key={userId}
                                        className="cursor-indicator"
                                        style={{
                                            left: `${cursor.x}px`,
                                            top: `${cursor.y}px`
                                        }}
                                    >
                                        <div style={{ 
                                            width: 0, 
                                            height: 0, 
                                            borderLeft: '10px solid transparent',
                                            borderRight: '10px solid transparent',
                                            borderTop: '15px solid #00c4cc'
                                        }} />
                                        <div className="cursor-label">{cursor.userName}</div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* 오른쪽 패널 */}
                        {selectedElementData && !showVersions && !showLayers && (
                            <div className="property-panel">
                                <h3 style={{ marginBottom: '16px', fontSize: '18px', fontWeight: '600' }}>
                                    속성
                                </h3>

                                <div className="property-section">
                                    <div className="property-label">위치</div>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
                                        <input
                                            type="number"
                                            className="text-input"
                                            value={Math.round(selectedElementData.x)}
                                            onChange={(e) => updateElement(selectedElement, { x: Number(e.target.value) })}
                                            placeholder="X"
                                        />
                                        <input
                                            type="number"
                                            className="text-input"
                                            value={Math.round(selectedElementData.y)}
                                            onChange={(e) => updateElement(selectedElement, { y: Number(e.target.value) })}
                                            placeholder="Y"
                                        />
                                    </div>
                                </div>

                                <div className="property-section">
                                    <div className="property-label">크기</div>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
                                        <input
                                            type="number"
                                            className="text-input"
                                            value={Math.round(selectedElementData.width)}
                                            onChange={(e) => updateElement(selectedElement, { width: Number(e.target.value) })}
                                            placeholder="너비"
                                        />
                                        <input
                                            type="number"
                                            className="text-input"
                                            value={Math.round(selectedElementData.height)}
                                            onChange={(e) => updateElement(selectedElement, { height: Number(e.target.value) })}
                                            placeholder="높이"
                                        />
                                    </div>
                                </div>

                                <div className="property-section">
                                    <div className="property-label">회전</div>
                                    <input
                                        type="range"
                                        className="slider"
                                        min="0"
                                        max="360"
                                        value={selectedElementData.rotation}
                                        onChange={(e) => updateElement(selectedElement, { rotation: Number(e.target.value) })}
                                    />
                                    <div style={{ textAlign: 'center', fontSize: '14px' }}>
                                        {selectedElementData.rotation}°
                                    </div>
                                </div>

                                <div className="property-section">
                                    <div className="property-label">투명도</div>
                                    <input
                                        type="range"
                                        className="slider"
                                        min="0"
                                        max="1"
                                        step="0.1"
                                        value={selectedElementData.opacity}
                                        onChange={(e) => updateElement(selectedElement, { opacity: Number(e.target.value) })}
                                    />
                                    <div style={{ textAlign: 'center', fontSize: '14px' }}>
                                        {Math.round(selectedElementData.opacity * 100)}%
                                    </div>
                                </div>

                                {selectedElementData.type !== 'text' && (
                                    <div className="property-section">
                                        <div className="property-label">색상</div>
                                        <input
                                            type="color"
                                            className="color-picker"
                                            value={selectedElementData.color || '#000000'}
                                            onChange={(e) => updateElement(selectedElement, { color: e.target.value })}
                                        />
                                    </div>
                                )}

                                {selectedElementData.type === 'text' && (
                                    <>
                                        <div className="property-section">
                                            <div className="property-label">글꼴 크기</div>
                                            <input
                                                type="number"
                                                className="text-input"
                                                value={selectedElementData.fontSize || 16}
                                                onChange={(e) => updateElement(selectedElement, { fontSize: Number(e.target.value) })}
                                            />
                                        </div>
                                        <div className="property-section">
                                            <div className="property-label">텍스트 색상</div>
                                            <input
                                                type="color"
                                                className="color-picker"
                                                value={selectedElementData.color || '#000000'}
                                                onChange={(e) => updateElement(selectedElement, { color: e.target.value })}
                                            />
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {/* 버전 히스토리 패널 */}
                        {showVersions && (
                            <div className="property-panel">
                                <h3 style={{ marginBottom: '16px', fontSize: '18px', fontWeight: '600' }}>
                                    버전 히스토리
                                </h3>
                                <div className="version-list">
                                    {versions.map(version => (
                                        <div 
                                            key={version.id}
                                            className="version-item"
                                            onClick={() => handleRestoreVersion(version.id)}
                                        >
                                            <div className="version-number">
                                                버전 {version.version_number}
                                            </div>
                                            <div className="version-info">
                                                {version.created_by_name} • {new Date(version.created_at).toLocaleString('ko-KR')}
                                            </div>
                                            {version.description && (
                                                <div style={{ fontSize: '12px', color: '#999', marginTop: '4px' }}>
                                                    {version.description}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* 레이어 패널 */}
                        {showLayers && (
                            <div className="property-panel">
                                <h3 style={{ marginBottom: '16px', fontSize: '18px', fontWeight: '600' }}>
                                    레이어
                                </h3>
                                <div className="layer-list">
                                    {elements.map((element, index) => (
                                        <div 
                                            key={element.id}
                                            className={`layer-item ${selectedElement === element.id ? 'selected' : ''}`}
                                            onClick={() => selectElement(element.id)}
                                        >
                                            <div className="layer-name">
                                                {element.type === 'text' ? (element.content || '텍스트') : element.type}
                                            </div>
                                            <div className="layer-controls">
                                                <button 
                                                    className="layer-btn"
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        moveLayer(index, -1);
                                                    }}
                                                    disabled={index === 0}
                                                >
                                                    ↑
                                                </button>
                                                <button 
                                                    className="layer-btn"
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        moveLayer(index, 1);
                                                    }}
                                                    disabled={index === elements.length - 1}
                                                >
                                                    ↓
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* 푸터 */}
                    <div className="footer">
                        <div className="zoom-controls">
                            <button 
                                className="toolbar-btn" 
                                onClick={() => setZoom(Math.max(10, zoom - 10))}
                            >
                                −
                            </button>
                            <span style={{ fontSize: '14px', minWidth: '60px', textAlign: 'center' }}>
                                {zoom}%
                            </span>
                            <button 
                                className="toolbar-btn" 
                                onClick={() => setZoom(Math.min(200, zoom + 10))}
                            >
                                +
                            </button>
                            
                            {addingComment && (
                                <span style={{ marginLeft: '16px', color: '#ff6b6b', fontWeight: '600' }}>
                                    💬 캔버스를 클릭하여 댓글 추가
                                </span>
                            )}
                        </div>
                        <div style={{ display: 'flex', gap: '16px', alignItems: 'center' }}>
                            <button 
                                className="toolbar-btn"
                                onClick={() => setAddingComment(!addingComment)}
                                style={{ 
                                    background: addingComment ? '#ff6b6b' : 'white',
                                    color: addingComment ? 'white' : 'inherit'
                                }}
                            >
                                {addingComment ? '💬 댓글 모드 ON' : '💬 댓글 추가'}
                            </button>
                            <div style={{ fontSize: '12px', color: '#999' }}>
                                마지막 저장: {lastSaved.toLocaleTimeString('ko-KR')}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<CanvaEditor />, document.getElementById('root'));
    </script>
</body>
</html>